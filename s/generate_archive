#!/bin/bash

# ==========================================
# Script Name: dummy_dicom_gen.sh
# Description: Generates dummy binary data in a YYYY/MM/DD structure.
# Requirements: Must be run as root (sudo).
# Usage: sudo ./script.sh -p /path/to/dicom/folder
# ==========================================

# 1. Check for Sudo (Root) Privileges
if [ "$EUID" -ne 0 ]; then
    echo "Error: This script must be run as root. Please use sudo."
    exit 1
fi

# 2. Parse Arguments using getopts to find the -p flag
DICOM_DIR=""

while getopts ":p:" opt; do
  case $opt in
    p)
      DICOM_DIR="$OPTARG"
      ;;
    \?)
      echo "Error: Invalid option -$OPTARG" >&2
      exit 1
      ;;
    :)
      echo "Error: Option -$OPTARG requires an argument." >&2
      exit 1
      ;;
  esac
done

# 3. Validation: Check if DICOM_DIR was provided
if [ -z "$DICOM_DIR" ]; then
    echo "Error: DICOM folder is not given."
    echo "Usage: sudo $0 -p /path/to/dicom/folder"
    exit 1
fi

echo "Starting dummy data generation in: $DICOM_DIR"

# Ensure the base DICOM directory exists
if [ ! -d "$DICOM_DIR" ]; then
    echo "Base directory '$DICOM_DIR' does not exist. Creating it..."
    mkdir -p "$DICOM_DIR"
fi

# 4. Main Generation Loop
for year in {2022..2025}; do
    YEAR_DIR="$DICOM_DIR/$year"

    # Check if Year folder exists
    if [ -d "$YEAR_DIR" ]; then
        echo "  [INFO] Year folder '$year' already exists. Skipping creation."
    else
        echo "  [CREATING] Year directory: $YEAR_DIR"
        mkdir -p "$YEAR_DIR"
    fi

    # Loop through the months 1 to 12
    for month in {1..12}; do
        MONTH_DIR="$YEAR_DIR/$month"
        
        # Check if Month folder exists
        if [ ! -d "$MONTH_DIR" ]; then
            # We only log if we are actually creating it to reduce noise
            # echo "    Creating month directory: $MONTH_DIR"
            mkdir -p "$MONTH_DIR"
        fi

        # Loop through the days 1 to 30
        for day in {1..30}; do
            DAY_DIR="$MONTH_DIR/$day"
            
            # Check if Day folder exists
            if [ ! -d "$DAY_DIR" ]; then
                mkdir -p "$DAY_DIR"
            fi

            DUMMY_FILE="$DAY_DIR/dummy_file.bin"

            # Check if the file already exists to avoid overwriting
            if [ -f "$DUMMY_FILE" ]; then
                # echo "      File $DUMMY_FILE exists. Skipping."
                continue 
            fi

            # Generate random size between 0 and 1MB
            FILE_SIZE_BYTES=$(shuf -i 0-1048576 -n 1)

            # echo "      Generating dummy file: $DUMMY_FILE ($FILE_SIZE_BYTES bytes)"
            head -c "$FILE_SIZE_BYTES" /dev/urandom > "$DUMMY_FILE"

            if [ $? -ne 0 ]; then
                echo "      Warning: Could not create dummy file '$DUMMY_FILE'."
            fi
        done
    done
done

echo "------------------------------------------------"
echo "Dummy data generation process finished."
echo "Target: $DICOM_DIR"
