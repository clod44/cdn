#!/bin/bash

SCRIPT_NAME=$(basename "$0")
CURRENT_TTY=$(tty)

usage() {
    echo "Usage: $SCRIPT_NAME <terminal_number> [mode] [data]"
    echo "Targeting Safety: Active Session is $CURRENT_TTY"
    echo ""
    echo "Available Targets:"
    who | awk '{print "  " $2 " (" $1 ")"}'
    echo ""
    echo "Modes:"
    echo "  -r   Random Flood (default)"
    echo "  -s   Geometric Spiral"
    echo "  -c   Custom Text"
    echo "  -t   Ghost Typing"
    echo "  -m   Matrix Rain"
    echo "  -k   Kernel Panic Simulation"
    echo "  -f   Fake Drive Format"
    echo "  -d   Disco Strobe"
    echo "  -w   Whitespace Annoyer"
    exit 1
}

if [ -z "$1" ]; then
    usage
fi

TERMINAL_NUMBER="$1"
TARGET_DEV="/dev/pts/${TERMINAL_NUMBER}"

if [ "$CURRENT_TTY" == "$TARGET_DEV" ]; then
    echo "Error: Safety lock engaged. You cannot flood your own terminal ($TARGET_DEV)."
    exit 1
fi

get_hardware_info() {
    REAL_DISK=$(lsblk -nd --output NAME 2>/dev/null | head -n 1)
    REAL_IFACE=$(ip -o link show 2>/dev/null | awk -F': ' '{print $2}' | grep -v "lo" | head -n 1)
    
    if [ -z "$REAL_DISK" ]; then REAL_DISK="nvme0n1"; fi
    if [ -z "$REAL_IFACE" ]; then REAL_IFACE="eth0"; fi
}

send_clear() {
    sudo sh -c "tput clear >> $TARGET_DEV" 2>/dev/null || sudo sh -c "yes '' | head -n 100 >> $TARGET_DEV"
}

flood_random() {
    echo "Flooding random data to $TARGET_DEV..."
    while true; do
        sudo sh -c "dd if=/dev/urandom bs=100K count=1 2>/dev/null | tr -cd '[:alnum:][:punct:]' >> $TARGET_DEV"
    done
}

flood_custom() {
    PAYLOAD="$1"
    [ -z "$PAYLOAD" ] && PAYLOAD=" "
    echo "Flooding custom string..."
    sudo sh -c "yes '$PAYLOAD' >> $TARGET_DEV"
}

flood_spiral() {
    echo "Flooding geometric pattern..."
    while true; do
        echo -e "      /      \n     /      \ \n    /        \ \n   /          \ \n   |          | \n   \          / \n    \        /  \n     \      /   "
    done | sudo tee "$TARGET_DEV" > /dev/null
}

flood_ghost() {
    PAYLOAD="$1"
    [ -z "$PAYLOAD" ] && PAYLOAD="I am watching you..."
    echo "Ghost typing..."
    for (( i=0; i<${#PAYLOAD}; i++ )); do
        CHAR="${PAYLOAD:$i:1}"
        printf "%s" "$CHAR" | sudo tee -a "$TARGET_DEV" > /dev/null
        sleep 0.15
    done
    echo "" | sudo tee -a "$TARGET_DEV" > /dev/null
}

flood_matrix() {
    echo "Flooding Matrix rain..."
    while true; do
        sudo sh -c "printf '\033[32m%s\033[0m\n' \"\$(tr -dc '01' < /dev/urandom | head -c \$(shuf -i 40-80 -n 1))\" >> $TARGET_DEV"
        sleep 0.05
    done
}

flood_panic() {
    get_hardware_info
    echo "Simulating Kernel Panic..."
    send_clear
    
    # Initial Hardware Failure Simulation
    sudo sh -c "printf '[  154.201455] sd 0:0:0:0: [sd%s] tag#0 FAILED Result: hostbyte=DID_OK driverbyte=DRIVER_SENSE\n' \"${REAL_DISK: -1}\" >> $TARGET_DEV"
    sleep 0.5
    sudo sh -c "printf '[  154.201882] sd 0:0:0:0: [sd%s] tag#0 Sense Key : Medium Error [current]\n' \"${REAL_DISK: -1}\" >> $TARGET_DEV"
    sleep 1

    # The "Try to Remount" Loop
    for i in {1..3}; do
         TS="15$(($i + 4)).$(shuf -i 100000-999999 -n 1)"
         
         sudo sh -c "printf '[  %s] EXT4-fs (%s): previous I/O error to superblock detected\n' \"$TS\" \"$REAL_DISK\" >> $TARGET_DEV"
         sleep 1
         
         sudo sh -c "printf '[  %s] EXT4-fs (%s): Remounting filesystem read-only\n' \"$TS\" \"$REAL_DISK\" >> $TARGET_DEV"
         sleep 0.5
         
         sudo sh -c "printf '[  %s] Buffer I/O error on dev %s, logical block 0, lost async page write\n' \"$TS\" \"$REAL_DISK\" >> $TARGET_DEV"
         sleep 0.5
    done

    sleep 1
    
    # Final Death
    {
        echo "Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,0)"
        echo "CPU: 0 PID: 1 Comm: swapper/0 Not tainted 5.4.0-42-generic"
        echo "Hardware name: QEMU Standard PC (i440FX + PIIX, 1996)"
        echo "Call Trace:"
        echo " <IRQ>"
        echo " dump_stack+0x6d/0x9a"
        echo " panic+0x101/0x2e3"
        echo " mount_block_root+0x23f/0x2e8"
        echo " </IRQ>"
        echo "---[ end Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,0) ]---"
    } | sudo tee -a "$TARGET_DEV" > /dev/null
}

flood_format() {
    get_hardware_info
    echo "Simulating Drive Format on /dev/$REAL_DISK..."
    send_clear
    
    {
        echo "CRITICAL ERROR: Inconsistent filesystem structure on /dev/$REAL_DISK"
        echo "Initiating emergency reformat to preserve sector integrity."
        echo "unmounting /dev/${REAL_DISK}p1..."
        sleep 1
        echo "unmounting /dev/${REAL_DISK}p2..."
        sleep 1
        echo "mkfs.ext4: /dev/$REAL_DISK contains a mounted filesystem"
        echo "Forcing overwrite..."
        sleep 1
    } | sudo tee -a "$TARGET_DEV" > /dev/null

    for i in {1..100}; do
        sudo sh -c "printf 'Formatting /dev/$REAL_DISK: [$i%%] \r' >> $TARGET_DEV"
        sleep 0.1
    done
    echo -e "\nFORMAT COMPLETE. REBOOTING..." | sudo tee -a "$TARGET_DEV" > /dev/null
}

flood_disco() {
    echo "Strobe mode engaged (CTRL+C to stop)..."
    while true; do
        COLOR=$(( (RANDOM % 7) + 41 ))
        TEXT=$(tr -dc 'A-Z0-9' < /dev/urandom | head -c 60)
        sudo sh -c "printf '\033[${COLOR}m%s\033[0m\a\n' \"$TEXT\" >> $TARGET_DEV"
        sleep 0.05
    done
}

flood_annoy() {
    echo "Whitespace annoyance active..."
    while true; do
        SLEEP_TIME=$(( (RANDOM % 5) + 1 ))
        sleep $SLEEP_TIME
        ACTION=$((RANDOM % 2))
        if [ $ACTION -eq 0 ]; then
             sudo sh -c "printf ' ' >> $TARGET_DEV"
        else
             sudo sh -c "printf '\n' >> $TARGET_DEV"
        fi
    done
}

MODE="$2"

case "$MODE" in
    -s) flood_spiral ;;
    -c) flood_custom "$3" ;;
    -t) flood_ghost "$3" ;;
    -m) flood_matrix ;;
    -k) flood_panic ;;
    -f) flood_format ;;
    -d) flood_disco ;;
    -w) flood_annoy ;;
    -r|*) flood_random ;;
esac